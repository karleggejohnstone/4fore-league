<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4FORE LEAGUE · Start a Round</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<style>
  :root {
    --green: #1a4a2e;
    --green-mid: #2d7a4f;
    --green-bright: #3ddc84;
    --gold: #c9a84c;
    --gold-light: #f0d080;
    --cream: #f5f0e8;
    --dark: #0d1a12;
    --red: #c0392b;
    --white: #ffffff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    color: var(--cream);
    font-family: 'Barlow', sans-serif;
    overflow-x: hidden;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* NAV */
  nav {
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 100;
    padding: 20px 48px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(to bottom, rgba(13,26,18,0.97), rgba(13,26,18,0.85));
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(201,168,76,0.1);
  }

  .nav-logo {
    font-family: 'Black Ops One', cursive;
    font-size: 1.8rem;
    color: var(--gold);
    letter-spacing: 0.05em;
    text-decoration: none;
  }

  .nav-logo span { color: var(--green-bright); }

  .nav-links {
    display: flex;
    gap: 36px;
    list-style: none;
  }

  .nav-links a {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--cream);
    text-decoration: none;
    opacity: 0.7;
    transition: opacity 0.2s, color 0.2s;
  }

  .nav-links a:hover { opacity: 1; color: var(--gold); }
  .nav-links a.active { opacity: 1; color: var(--gold); }

  /* PAGE */
  .page {
    padding: 120px 48px 80px;
    max-width: 760px;
    margin: 0 auto;
  }

  .page-eyebrow {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--green-bright);
    margin-bottom: 12px;
  }

  .page-title {
    font-family: 'Black Ops One', cursive;
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    color: var(--gold);
    line-height: 1;
    margin-bottom: 16px;
  }

  .page-subtitle {
    font-size: 1rem;
    color: rgba(245,240,232,0.6);
    line-height: 1.6;
    max-width: 480px;
    margin-bottom: 48px;
  }

  /* PLAYERS LIST */
  .players-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* PLAYER CARD */
  .player-card {
    background: rgba(45,122,79,0.07);
    border: 1px solid rgba(201,168,76,0.18);
    animation: slideIn 0.25s ease-out;
  }

  .player-card-top {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: stretch;
  }

  .player-name-input {
    background: transparent;
    border: none;
    border-bottom: 1px solid rgba(201,168,76,0.15);
    color: var(--cream);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 1.15rem;
    font-weight: 700;
    padding: 16px 20px;
    outline: none;
    width: 100%;
    letter-spacing: 0.03em;
    transition: background 0.2s;
  }

  .player-name-input::placeholder {
    color: rgba(245,240,232,0.2);
    font-weight: 400;
  }

  .player-name-input:focus {
    background: rgba(45,122,79,0.12);
  }

  .player-remove {
    background: transparent;
    border: none;
    border-left: 1px solid rgba(201,168,76,0.1);
    border-bottom: 1px solid rgba(201,168,76,0.15);
    color: rgba(192,57,43,0.35);
    font-size: 0.9rem;
    cursor: pointer;
    padding: 0 18px;
    transition: background 0.2s, color 0.2s;
  }

  .player-remove:hover {
    background: rgba(192,57,43,0.12);
    color: var(--red);
  }

  /* METHOD TABS */
  .method-tabs {
    display: flex;
    border-bottom: 1px solid rgba(201,168,76,0.12);
  }

  .method-tab {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.35);
    padding: 10px 18px;
    cursor: pointer;
    border: none;
    background: transparent;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: color 0.2s, border-color 0.2s;
    white-space: nowrap;
  }

  .method-tab:hover {
    color: rgba(245,240,232,0.65);
  }

  .method-tab.active {
    color: var(--gold);
    border-bottom-color: var(--gold);
  }

  /* METHOD PANELS */
  .method-panels {
    padding: 16px 20px 18px;
  }

  .method-panel {
    display: none;
  }

  .method-panel.active {
    display: block;
  }

  .method-input-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .method-input-wrap {
    flex: 0 0 140px;
  }

  .method-input {
    background: rgba(13,26,18,0.8);
    border: 1px solid rgba(201,168,76,0.25);
    color: var(--cream);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    padding: 12px 16px;
    outline: none;
    width: 100%;
    transition: border-color 0.2s, background 0.2s;
    -moz-appearance: textfield;
  }

  .method-input::-webkit-outer-spin-button,
  .method-input::-webkit-inner-spin-button { -webkit-appearance: none; }

  .method-input::placeholder {
    color: rgba(245,240,232,0.2);
    font-weight: 400;
    font-size: 1rem;
  }

  .method-input:focus {
    border-color: rgba(201,168,76,0.55);
    background: rgba(45,122,79,0.15);
  }

  .method-note {
    font-size: 0.78rem;
    color: rgba(245,240,232,0.3);
    margin-top: 6px;
    font-style: italic;
    line-height: 1.4;
  }

  /* RESULT DISPLAY */
  .result-display {
    display: flex;
    gap: 8px;
    align-items: stretch;
    flex: 1;
  }

  .result-cell {
    flex: 1;
    background: rgba(13,26,18,0.7);
    border: 1px solid rgba(201,168,76,0.12);
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 3px;
    min-width: 0;
  }

  .result-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.28);
    line-height: 1;
    white-space: nowrap;
  }

  .result-value {
    font-family: 'Black Ops One', cursive;
    font-size: 1.25rem;
    line-height: 1;
    color: rgba(245,240,232,0.15);
  }

  .result-value.active-low  { color: var(--green-bright); }
  .result-value.active-mid  { color: var(--gold); }
  .result-value.active-high { color: var(--gold-light); }
  .result-value.active-hs   { color: var(--cream); }

  .result-sub {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.65rem;
    color: rgba(245,240,232,0.3);
    line-height: 1;
  }

  /* ADD PLAYER BUTTON */
  .btn-add {
    width: 100%;
    background: transparent;
    border: 1px dashed rgba(201,168,76,0.25);
    color: var(--gold);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 15px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 2px;
  }

  .btn-add:hover:not(:disabled) {
    background: rgba(201,168,76,0.06);
    border-color: rgba(201,168,76,0.5);
  }

  .btn-add:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  /* START ROUND */
  .start-section {
    margin-top: 40px;
    display: flex;
    align-items: center;
    gap: 24px;
    flex-wrap: wrap;
  }

  .btn-start {
    background: var(--gold);
    color: var(--dark);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.1rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 20px 56px;
    border: none;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s, opacity 0.2s;
    clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
  }

  .btn-start:hover:not(:disabled) {
    background: var(--gold-light);
    transform: translateY(-2px);
  }

  .btn-start:disabled {
    opacity: 0.25;
    cursor: not-allowed;
    transform: none;
  }

  .start-hint {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.85rem;
    color: rgba(245,240,232,0.35);
    letter-spacing: 0.05em;
  }

  /* JOIN SECTION */
  .section-divider {
    margin: 56px 0 48px;
    border: none;
    border-top: 1px solid rgba(201,168,76,0.12);
    position: relative;
  }

  .section-divider::after {
    content: 'OR';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--dark);
    padding: 0 16px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.3em;
    color: rgba(201,168,76,0.3);
  }

  .join-eyebrow {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--green-bright);
    margin-bottom: 8px;
  }

  .join-title {
    font-family: 'Black Ops One', cursive;
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 8px;
  }

  .join-subtitle {
    font-size: 0.9rem;
    color: rgba(245,240,232,0.45);
    margin-bottom: 28px;
    line-height: 1.5;
  }

  .join-row {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .join-code-input {
    background: rgba(13,26,18,0.8);
    border: 1px solid rgba(201,168,76,0.25);
    color: var(--cream);
    font-family: 'Black Ops One', cursive;
    font-size: 1.8rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    padding: 16px 24px;
    width: 180px;
    outline: none;
    text-align: center;
    transition: border-color 0.2s, background 0.2s;
  }

  .join-code-input::placeholder {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 1rem;
    letter-spacing: 0.1em;
    color: rgba(245,240,232,0.2);
    font-weight: 400;
  }

  .join-code-input:focus {
    border-color: rgba(201,168,76,0.55);
    background: rgba(45,122,79,0.15);
  }

  .btn-join {
    background: transparent;
    border: 1px solid rgba(201,168,76,0.4);
    color: var(--gold);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 18px 40px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s, color 0.2s;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  .btn-join:hover:not(:disabled) {
    background: rgba(201,168,76,0.1);
    border-color: var(--gold);
  }

  .btn-join:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .join-error {
    margin-top: 10px;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.85rem;
    color: var(--red);
    letter-spacing: 0.05em;
    min-height: 1.2em;
  }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(13,26,18,0.97);
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--cream);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    padding: 14px 24px;
    z-index: 9999;
    pointer-events: none;
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
    white-space: nowrap;
    backdrop-filter: blur(8px);
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .toast.error { border-color: rgba(192,57,43,0.5); color: var(--red); }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    nav { padding: 16px 24px; }
    .nav-links { display: none; }
    .page { padding: 100px 20px 60px; }
    .method-tab { padding: 10px 12px; font-size: 0.68rem; }
  }

  @media (max-width: 520px) {
    .method-input-row { flex-direction: column; }
    .method-input-wrap { flex: none; width: 100%; }
    .result-display { width: 100%; }
  }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <a href="index.html" class="nav-logo">4<span>FORE</span></a>
  <ul class="nav-links">
    <li><a href="index.html#how-it-works">How It Works</a></li>
    <li><a href="index.html#scoring">Scoring</a></li>
    <li><a href="index.html#declarations">Declarations</a></li>
    <li><a href="index.html#moments">Moments</a></li>
    <li><a href="index.html#scorecard">Scorecard</a></li>
    <li><a href="round.html" class="active">Start Round</a></li>
    <li><a href="login.html" id="nav-auth-link" style="color:var(--gold);opacity:1;">Sign In</a></li>
  </ul>
</nav>
<script>
  (async () => {
    const session = await auth.getSession();
    const link = document.getElementById('nav-auth-link');
    if (session) { link.href = 'account.html'; link.textContent = 'Account'; }
  })();
</script>

<!-- PAGE -->
<div class="page">
  <p class="page-eyebrow">4Fore League</p>
  <h1 class="page-title">Start a Round</h1>
  <p class="page-subtitle">Add up to 6 players. Choose how each player wants to enter their handicap — the tier and head start are calculated automatically.</p>

  <div id="playersList" class="players-list"></div>

  <button class="btn-add" id="addPlayerBtn" onclick="addPlayer()">
    <span>+</span> Add Player
  </button>

  <div class="start-section">
    <button class="btn-start" id="startRoundBtn" disabled onclick="startRound()">Start Round</button>
    <p class="start-hint" id="startHint">Add at least 2 players to begin</p>
  </div>

  <hr class="section-divider">

  <div class="join-section">
    <p class="join-eyebrow">Join a Round in Progress</p>
    <h2 class="join-title">Enter Code</h2>
    <p class="join-subtitle">Get the 4-character code from the scorecard device and join as a scorer.</p>
    <div class="join-row">
      <input
        class="join-code-input"
        id="joinCodeInput"
        type="text"
        maxlength="4"
        placeholder="A3X7"
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
        oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,''); updateJoinButton()"
        onkeydown="if(event.key==='Enter') joinRound()"
        aria-label="4-character round code"
      />
      <button class="btn-join" id="joinBtn" disabled onclick="joinRound()">Join Round</button>
    </div>
    <p class="join-error" id="joinError"></p>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let playerCount = 0;
  const MAX_PLAYERS = 6;

  // Returns tier info from a handicap index value (0–54)
  function tierFromIndex(h) {
    if (h === null || h === '' || isNaN(h)) return null;
    const n = parseInt(h, 10);
    if (n < 0) return null;
    if (n <= 6)  return { cls: 'active-low',  name: 'Low · Scratch–6', mult: '1.5×',  hsVal: Math.floor(n / 2) };
    if (n <= 13) return { cls: 'active-mid',  name: 'Mid · 7–13',      mult: '1.75×', hsVal: Math.floor(n / 2) };
    return            { cls: 'active-high', name: 'High · 14+',      mult: '2.0×',  hsVal: Math.floor(n / 2) };
  }

  // Returns tier info from an average score value
  function tierFromScore(s) {
    if (s === null || s === '' || isNaN(s)) return null;
    const n = parseInt(s, 10);
    if (n < 1) return null;
    if (n < 75)  return { cls: 'active-low',  name: 'Low · Scratch–6', mult: '1.5×',  hsVal: 3 };
    if (n <= 85) return { cls: 'active-mid',  name: 'Mid · 7–13',      mult: '1.75×', hsVal: 6 };
    return             { cls: 'active-high', name: 'High · 14+',      mult: '2.0×',  hsVal: 9 };
  }

  function renderResult(id, tier) {
    const activePanel = document.querySelector('#player-' + id + ' .method-panel.active');
    if (!activePanel) return;
    const multEl = activePanel.querySelector('.result-value.mult-val');
    const hsEl   = activePanel.querySelector('.result-value.hs-val');
    const subEl  = activePanel.querySelector('.result-sub');

    if (!tier) {
      multEl.className = 'result-value mult-val';
      multEl.textContent = '—';
      hsEl.className = 'result-value hs-val';
      hsEl.textContent = '—';
      if (subEl) subEl.textContent = '';
    } else {
      multEl.className = 'result-value mult-val ' + tier.cls;
      multEl.textContent = tier.mult;
      hsEl.className = 'result-value hs-val active-hs';
      hsEl.textContent = '+' + tier.hsVal;
      if (subEl) subEl.textContent = tier.name;
    }

    updateStartButton();
  }

  function onIndexInput(id, val) { renderResult(id, tierFromIndex(val)); }
  function onScoreInput(id, val) { renderResult(id, tierFromScore(val)); }
  function onGhinInput(id, val)  { renderResult(id, tierFromIndex(val)); }

  function switchTab(id, method) {
    ['index','score','ghin'].forEach(m => {
      document.getElementById('tab-' + m + '-' + id).classList.toggle('active', m === method);
      document.getElementById('panel-' + m + '-' + id).classList.toggle('active', m === method);
    });
    renderResult(id, null);
    document.querySelectorAll('#player-' + id + ' .method-input').forEach(el => el.value = '');
    const panel = document.getElementById('panel-' + method + '-' + id);
    const inp = panel.querySelector('.method-input');
    if (inp) inp.focus();
  }

  function addPlayer() {
    if (playerCount >= MAX_PLAYERS) return;
    playerCount++;
    const id = Date.now();

    const card = document.createElement('div');
    card.className = 'player-card';
    card.id = 'player-' + id;

    card.innerHTML = `
      <div class="player-card-top">
        <input
          class="player-name-input"
          type="text"
          placeholder="Player ${playerCount} name"
          oninput="updateStartButton()"
          aria-label="Player name"
        />
        <button class="player-remove" onclick="removePlayer('player-${id}')" aria-label="Remove player">✕</button>
      </div>

      <div class="method-tabs">
        <button class="method-tab active" id="tab-index-${id}" onclick="switchTab(${id},'index')">Handicap Index</button>
        <button class="method-tab"        id="tab-score-${id}" onclick="switchTab(${id},'score')">Average Score</button>
        <button class="method-tab"        id="tab-ghin-${id}"  onclick="switchTab(${id},'ghin')">GHIN Number</button>
      </div>

      <div class="method-panels">

        <div class="method-panel active" id="panel-index-${id}">
          <div class="method-input-row">
            <div class="method-input-wrap">
              <input class="method-input" type="number" placeholder="0 – 54" min="0" max="54"
                oninput="onIndexInput(${id}, this.value)" aria-label="Handicap index"/>
            </div>
            <div class="result-display">
              <div class="result-cell">
                <span class="result-label">Multiplier</span>
                <span class="result-value mult-val">—</span>
                <span class="result-sub"></span>
              </div>
              <div class="result-cell">
                <span class="result-label">Head Start</span>
                <span class="result-value hs-val">—</span>
              </div>
            </div>
          </div>
        </div>

        <div class="method-panel" id="panel-score-${id}">
          <div class="method-input-row">
            <div class="method-input-wrap">
              <input class="method-input" type="number" placeholder="e.g. 82" min="55" max="150"
                oninput="onScoreInput(${id}, this.value)" aria-label="Average 18-hole score"/>
              <p class="method-note">Typical 18-hole score</p>
            </div>
            <div class="result-display">
              <div class="result-cell">
                <span class="result-label">Multiplier</span>
                <span class="result-value mult-val">—</span>
                <span class="result-sub"></span>
              </div>
              <div class="result-cell">
                <span class="result-label">Head Start</span>
                <span class="result-value hs-val">—</span>
              </div>
            </div>
          </div>
        </div>

        <div class="method-panel" id="panel-ghin-${id}">
          <div class="method-input-row">
            <div class="method-input-wrap">
              <input class="method-input" type="number" placeholder="GHIN #" min="0"
                oninput="onGhinInput(${id}, this.value)" aria-label="GHIN number"/>
              <p class="method-note">Official USGA lookup coming soon — treated as handicap index for now</p>
            </div>
            <div class="result-display">
              <div class="result-cell">
                <span class="result-label">Multiplier</span>
                <span class="result-value mult-val">—</span>
                <span class="result-sub"></span>
              </div>
              <div class="result-cell">
                <span class="result-label">Head Start</span>
                <span class="result-value hs-val">—</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    `;

    document.getElementById('playersList').appendChild(card);
    updateAddButton();
    updateStartButton();
    card.querySelector('.player-name-input').focus();
  }

  function removePlayer(playerId) {
    const el = document.getElementById(playerId);
    if (!el) return;
    el.style.transition = 'opacity 0.15s, transform 0.15s';
    el.style.opacity = '0';
    el.style.transform = 'translateY(-6px)';
    setTimeout(() => {
      el.remove();
      playerCount--;
      updateAddButton();
      updateStartButton();
    }, 150);
  }

  function updateAddButton() {
    const btn = document.getElementById('addPlayerBtn');
    const count = document.getElementById('playersList').children.length;
    btn.disabled = count >= MAX_PLAYERS;
    btn.innerHTML = count >= MAX_PLAYERS
      ? '<span>✓</span> Max Players Reached (6)'
      : '<span>+</span> Add Player';
  }

  function playerHasTier(card) {
    const activePanel = card.querySelector('.method-panel.active');
    if (!activePanel) return false;
    const multEl = activePanel.querySelector('.mult-val');
    return multEl && (
      multEl.classList.contains('active-low') ||
      multEl.classList.contains('active-mid') ||
      multEl.classList.contains('active-high')
    );
  }

  function updateStartButton() {
    const cards = document.getElementById('playersList').querySelectorAll('.player-card');
    const btn   = document.getElementById('startRoundBtn');
    const hint  = document.getElementById('startHint');
    let ready = 0, missingTier = 0;

    cards.forEach(card => {
      const name = card.querySelector('.player-name-input').value.trim();
      if (!name) return;
      if (playerHasTier(card)) ready++;
      else missingTier++;
    });

    const total = ready + missingTier;
    btn.disabled = ready < 2;

    if (total === 0)          hint.textContent = 'Add at least 2 players to begin';
    else if (missingTier > 0) hint.textContent = `${missingTier} player${missingTier > 1 ? 's' : ''} still need${missingTier === 1 ? 's' : ''} a handicap`;
    else if (ready === 1)     hint.textContent = 'Add one more player to begin';
    else                      hint.textContent = `${ready} players ready`;
  }

  // ── Toast ─────────────────────────────────────────────────────────
  let toastTimer = null;
  function showToast(msg, isError = false) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.toggle('error', isError);
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 3200);
  }

  // ── Join button state ─────────────────────────────────────────────
  function updateJoinButton() {
    const val = document.getElementById('joinCodeInput').value;
    document.getElementById('joinBtn').disabled = val.length !== 4;
    document.getElementById('joinError').textContent = '';
  }

  // ── Derive 4-char code from UUID ──────────────────────────────────
  function codeFromUUID(uuid) {
    const hex = uuid.replace(/-/g, '').slice(0, 8);
    const n   = parseInt(hex, 16);
    return n.toString(36).toUpperCase().padStart(4, '0').slice(-4);
  }

  // ── Start Round (async — writes to Supabase) ──────────────────────
  async function startRound() {
    const btn  = document.getElementById('startRoundBtn');
    const hint = document.getElementById('startHint');
    btn.disabled = true;
    hint.textContent = 'Creating round…';

    const cards   = document.getElementById('playersList').querySelectorAll('.player-card');
    const players = [];
    cards.forEach(card => {
      const name = card.querySelector('.player-name-input').value.trim();
      if (!name || !playerHasTier(card)) return;
      const activePanel = card.querySelector('.method-panel.active');
      const multEl = activePanel ? activePanel.querySelector('.mult-val') : null;
      const hsEl   = activePanel ? activePanel.querySelector('.hs-val')   : null;
      const multRaw = multEl ? multEl.textContent.replace('×', '').trim() : '1.5';
      const hsRaw   = hsEl   ? hsEl.textContent.replace('+', '').trim()   : '0';
      players.push({ name, mult: parseFloat(multRaw), hs: parseFloat(hsRaw) });
    });

    try {
      // Insert round with placeholder code (must satisfy NOT NULL + length=4 check)
      const { data: roundData, error: roundErr } = await window.sb
        .from('rounds')
        .insert({ status: 'active', code: 'INIT' })
        .select('id')
        .single();

      if (roundErr) throw roundErr;

      const roundId   = roundData.id;
      const roundCode = codeFromUUID(roundId);

      // Update with the real derived code
      const { error: codeErr } = await window.sb
        .from('rounds')
        .update({ code: roundCode })
        .eq('id', roundId);

      if (codeErr) throw codeErr;

      // Insert all players
      const playerRows = players.map((p, idx) => ({
        round_id:     roundId,
        player_index: idx,
        name:         p.name,
        multiplier:   p.mult,
        head_start:   p.hs,
      }));

      const { error: playersErr } = await window.sb
        .from('round_players')
        .insert(playerRows);

      if (playersErr) throw playersErr;

      window.location.href = 'scorecard.html?round=' + roundId;

    } catch (err) {
      console.error('startRound error:', err);
      showToast('Could not save round — check connection', true);
      btn.disabled = false;
      updateStartButton();
    }
  }

  // ── Join Round ────────────────────────────────────────────────────
  async function joinRound() {
    const code  = document.getElementById('joinCodeInput').value.trim().toUpperCase();
    const btn   = document.getElementById('joinBtn');
    const errEl = document.getElementById('joinError');

    if (code.length !== 4) return;
    btn.disabled = true;
    errEl.textContent = '';

    try {
      const { data, error } = await window.sb
        .from('rounds')
        .select('id, status')
        .eq('code', code)
        .single();

      if (error || !data) {
        errEl.textContent = 'Round not found. Check the code and try again.';
        btn.disabled = false;
        return;
      }

      window.location.href = 'scorecard.html?round=' + data.id;

    } catch (err) {
      console.error('joinRound error:', err);
      errEl.textContent = 'Connection error. Try again.';
      btn.disabled = false;
    }
  }

  // Start with one player card
  addPlayer();
</script>

</body>
</html>
