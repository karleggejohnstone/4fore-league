<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4FORE LEAGUE ¬∑ Live Scorecard</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<style>
  :root {
    --green: #1a4a2e;
    --green-mid: #2d7a4f;
    --green-bright: #3ddc84;
    --gold: #c9a84c;
    --gold-light: #f0d080;
    --cream: #f5f0e8;
    --dark: #0d1a12;
    --red: #c0392b;
    --white: #ffffff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    color: var(--cream);
    font-family: 'Barlow', sans-serif;
    overflow-x: hidden;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* NAV */
  nav {
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 200;
    padding: 16px 48px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(13,26,18,0.98);
    border-bottom: 1px solid rgba(201,168,76,0.12);
    backdrop-filter: blur(8px);
  }

  .nav-logo {
    font-family: 'Black Ops One', cursive;
    font-size: 1.6rem;
    color: var(--gold);
    letter-spacing: 0.05em;
    text-decoration: none;
  }

  .nav-logo span { color: var(--green-bright); }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .nav-round-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.4);
  }

  .btn-end-round {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(192,57,43,0.6);
    background: transparent;
    border: 1px solid rgba(192,57,43,0.25);
    padding: 7px 16px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }

  .btn-end-round:hover {
    color: var(--red);
    border-color: rgba(192,57,43,0.6);
    background: rgba(192,57,43,0.08);
  }

  /* LEADERBOARD */
  .leaderboard {
    position: sticky;
    top: 57px;
    z-index: 90;
    background: rgba(13,26,18,0.97);
    border-bottom: 2px solid rgba(201,168,76,0.15);
    backdrop-filter: blur(8px);
    padding: 10px 24px;
    display: flex;
    gap: 8px;
    overflow-x: auto;
  }

  .leaderboard::-webkit-scrollbar { height: 3px; }
  .leaderboard::-webkit-scrollbar-thumb { background: rgba(201,168,76,0.3); }

  .lb-card {
    background: rgba(45,122,79,0.08);
    border: 1px solid rgba(201,168,76,0.15);
    padding: 8px 14px;
    min-width: 110px;
    flex-shrink: 0;
    position: relative;
    transition: border-color 0.3s;
  }

  .lb-card.rank-1 { border-color: var(--gold); background: rgba(201,168,76,0.08); }
  .lb-card.rank-2 { border-color: rgba(180,180,180,0.4); }
  .lb-card.rank-3 { border-color: rgba(61,220,132,0.3); }

  .lb-rank {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.3);
    line-height: 1;
    margin-bottom: 3px;
  }

  .lb-card.rank-1 .lb-rank { color: var(--gold); }
  .lb-card.rank-2 .lb-rank { color: rgba(200,200,200,0.6); }
  .lb-card.rank-3 .lb-rank { color: var(--green-bright); }

  .lb-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: var(--cream);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
  }

  .lb-score {
    font-family: 'Black Ops One', cursive;
    font-size: 1.2rem;
    color: var(--gold);
    line-height: 1;
    margin-top: 2px;
  }

  .lb-card.rank-1 .lb-score { color: var(--gold-light); font-size: 1.35rem; }

  /* MAIN CONTENT */
  .page {
    padding-top: 130px; /* nav + leaderboard */
    padding-bottom: 80px;
    max-width: 720px;
    margin: 0 auto;
    padding-left: 24px;
    padding-right: 24px;
  }

  /* HOLE NAVIGATION */
  .hole-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 16px;
  }

  .hole-nav-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.4);
    white-space: nowrap;
  }

  .btn-nav {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--cream);
    background: rgba(45,122,79,0.1);
    border: 1px solid rgba(201,168,76,0.2);
    padding: 10px 24px;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    white-space: nowrap;
  }

  .btn-nav:hover:not(:disabled) {
    background: rgba(45,122,79,0.25);
    border-color: rgba(201,168,76,0.45);
  }

  .btn-nav:disabled {
    opacity: 0.25;
    cursor: not-allowed;
  }

  /* HOLE PANEL */
  .hole-panel {
    background: rgba(45,122,79,0.06);
    border: 1px solid rgba(201,168,76,0.15);
  }

  .hole-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 24px;
    border-bottom: 1px solid rgba(201,168,76,0.12);
    flex-wrap: wrap;
    gap: 12px;
  }

  .hole-number {
    font-family: 'Black Ops One', cursive;
    font-size: 2rem;
    color: var(--gold);
    line-height: 1;
  }

  .par-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.35);
    margin-bottom: 6px;
  }

  .par-selector {
    display: flex;
    gap: 2px;
  }

  .par-btn {
    font-family: 'Black Ops One', cursive;
    font-size: 1rem;
    color: rgba(245,240,232,0.35);
    background: rgba(13,26,18,0.7);
    border: 1px solid rgba(201,168,76,0.15);
    padding: 8px 18px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .par-btn:hover { color: rgba(245,240,232,0.7); border-color: rgba(201,168,76,0.35); }

  .par-btn.active {
    background: var(--gold);
    color: var(--dark);
    border-color: var(--gold);
  }

  /* PLAYER ROWS */
  .player-scoring-row {
    padding: 20px 24px;
    border-bottom: 1px solid rgba(201,168,76,0.08);
  }

  .player-scoring-row:last-child { border-bottom: none; }

  .player-row-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 14px;
    gap: 12px;
  }

  .player-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.5);
  }

  .player-mult-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: rgba(245,240,232,0.25);
    margin-left: 8px;
  }

  .player-hole-score {
    font-family: 'Black Ops One', cursive;
    font-size: 1.5rem;
    color: rgba(245,240,232,0.15);
    line-height: 1;
    transition: color 0.2s;
  }

  .player-hole-score.has-score { color: var(--gold); }

  .inputs-row {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .input-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.28);
  }

  .strokes-input {
    background: rgba(13,26,18,0.85);
    border: 1px solid rgba(201,168,76,0.25);
    color: var(--cream);
    font-family: 'Black Ops One', cursive;
    font-size: 1.6rem;
    padding: 10px 14px;
    width: 80px;
    outline: none;
    text-align: center;
    transition: border-color 0.2s, background 0.2s;
    -moz-appearance: textfield;
  }

  .strokes-input::-webkit-outer-spin-button,
  .strokes-input::-webkit-inner-spin-button { -webkit-appearance: none; }

  .strokes-input:focus {
    border-color: rgba(201,168,76,0.6);
    background: rgba(45,122,79,0.15);
  }

  .declaration-select {
    background: rgba(13,26,18,0.85);
    border: 1px solid rgba(201,168,76,0.2);
    color: var(--cream);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 10px 12px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    min-width: 180px;
  }

  .declaration-select:focus { border-color: rgba(201,168,76,0.5); }

  /* HIT / MISS TOGGLE */
  .hit-miss-wrap {
    display: flex;
    gap: 2px;
  }

  .hit-btn, .miss-btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 10px 16px;
    border: 1px solid rgba(201,168,76,0.2);
    background: rgba(13,26,18,0.7);
    color: rgba(245,240,232,0.35);
    cursor: pointer;
    transition: all 0.15s;
  }

  .hit-btn:hover  { background: rgba(45,122,79,0.2); color: var(--green-bright); }
  .miss-btn:hover { background: rgba(192,57,43,0.15); color: var(--red); }

  .hit-btn.active  { background: var(--green-mid); color: var(--cream); border-color: var(--green-mid); }
  .miss-btn.active { background: var(--red); color: var(--white); border-color: var(--red); }

  /* MOMENT BUTTONS */
  .moments-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .moment-btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border: 1px solid rgba(61,220,132,0.2);
    color: rgba(61,220,132,0.4);
    background: transparent;
    padding: 6px 12px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .moment-btn:hover {
    border-color: rgba(61,220,132,0.5);
    color: rgba(61,220,132,0.8);
    background: rgba(61,220,132,0.06);
  }

  .moment-btn.active {
    background: rgba(61,220,132,0.12);
    border-color: var(--green-bright);
    color: var(--green-bright);
  }

  .moment-btn[data-moment="hio"] {
    border-color: rgba(201,168,76,0.3);
    color: rgba(201,168,76,0.5);
  }
  .moment-btn[data-moment="hio"]:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }
  .moment-btn[data-moment="hio"].active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.15); }

  /* HOLE PROGRESS BAR */
  .hole-progress {
    display: flex;
    gap: 2px;
    margin-bottom: 16px;
  }

  .hole-pip {
    flex: 1;
    height: 3px;
    background: rgba(255,255,255,0.07);
    border-radius: 2px;
    transition: background 0.2s;
    cursor: pointer;
  }

  .hole-pip.current { background: var(--gold); }
  .hole-pip.scored  { background: rgba(61,220,132,0.5); }

  /* NO PLAYERS STATE */
  .no-players {
    text-align: center;
    padding: 80px 24px;
  }

  .no-players h2 {
    font-family: 'Black Ops One', cursive;
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 16px;
  }

  .no-players p {
    color: rgba(245,240,232,0.5);
    margin-bottom: 32px;
  }

  .btn-primary {
    background: var(--gold);
    color: var(--dark);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 16px 40px;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
  }

  /* VIEW TOGGLE */
  .view-toggle {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
  }

  .toggle-btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 9px 20px;
    border: 1px solid rgba(201,168,76,0.2);
    background: transparent;
    color: rgba(245,240,232,0.4);
    cursor: pointer;
    transition: all 0.15s;
  }

  .toggle-btn.active {
    background: rgba(201,168,76,0.12);
    border-color: var(--gold);
    color: var(--gold);
  }

  .toggle-btn:hover:not(.active) {
    color: rgba(245,240,232,0.75);
    border-color: rgba(201,168,76,0.4);
  }

  /* FULL SCORECARD TABLE */
  .full-scorecard-wrap {
    display: none;
    overflow-x: auto;
  }

  .full-scorecard-wrap.visible { display: block; }

  .full-scorecard-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 560px;
    font-family: 'Barlow Condensed', sans-serif;
  }

  .full-scorecard-table thead th {
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--gold);
    padding: 10px 12px;
    background: rgba(13,26,18,0.95);
    border-bottom: 2px solid rgba(201,168,76,0.25);
    white-space: nowrap;
    text-align: left;
  }

  .full-scorecard-table thead th.player-col {
    border-left: 1px solid rgba(201,168,76,0.12);
    text-align: center;
  }

  .full-scorecard-table tbody tr {
    cursor: pointer;
    transition: background 0.15s;
  }

  .full-scorecard-table tbody tr:hover td { background: rgba(45,122,79,0.18); }

  .full-scorecard-table tbody tr.hole-current td {
    background: rgba(201,168,76,0.08);
    border-top: 1px solid rgba(201,168,76,0.3);
    border-bottom: 1px solid rgba(201,168,76,0.3);
  }

  .full-scorecard-table tbody tr.hole-unplayed td { opacity: 0.35; }

  .full-scorecard-table td {
    padding: 9px 12px;
    font-size: 0.88rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    vertical-align: middle;
    white-space: nowrap;
  }

  .full-scorecard-table td.player-col {
    border-left: 1px solid rgba(201,168,76,0.08);
    text-align: center;
  }

  .sc-hole-num {
    font-family: 'Black Ops One', cursive;
    font-size: 1rem;
    color: var(--gold);
  }

  .sc-par { color: rgba(245,240,232,0.45); font-size: 0.8rem; }

  .sc-pts {
    font-family: 'Black Ops One', cursive;
    font-size: 1rem;
    color: var(--gold);
  }

  .sc-score-detail {
    font-size: 0.72rem;
    color: rgba(245,240,232,0.4);
    line-height: 1.3;
  }

  .sc-hit  { color: var(--green-bright); font-weight: 700; }
  .sc-miss { color: var(--red); font-weight: 700; }
  .sc-moments { font-size: 0.7rem; color: rgba(201,168,76,0.7); }

  /* TOTALS ROW */
  .full-scorecard-table tfoot tr td {
    background: rgba(13,26,18,0.9);
    border-top: 2px solid rgba(201,168,76,0.3);
    font-weight: 700;
  }

  .tfoot-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.35);
    display: block;
    margin-bottom: 2px;
  }

  .tfoot-val {
    font-family: 'Black Ops One', cursive;
    font-size: 1rem;
    color: var(--gold-light);
    display: block;
  }

  .tfoot-total {
    font-family: 'Black Ops One', cursive;
    font-size: 1.4rem;
    color: var(--gold-light);
  }

  .tfoot-breakdown {
    font-size: 0.7rem;
    color: rgba(245,240,232,0.35);
    line-height: 1.6;
    margin-top: 3px;
  }

  /* ROUND CODE BADGE */
  .round-code-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    border: 1px solid rgba(201,168,76,0.3);
    background: rgba(201,168,76,0.05);
  }

  .round-code-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.4);
    white-space: nowrap;
  }

  .round-code-value {
    font-family: 'Black Ops One', cursive;
    font-size: 1.1rem;
    color: var(--gold);
    letter-spacing: 0.15em;
  }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: rgba(13,26,18,0.97);
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--cream);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    padding: 14px 24px;
    z-index: 9999;
    pointer-events: none;
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
    white-space: nowrap;
    backdrop-filter: blur(8px);
  }

  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  .toast.error { border-color: rgba(192,57,43,0.5); color: var(--red); }

  /* LOADING OVERLAY */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: var(--dark);
    z-index: 9998;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    transition: opacity 0.4s;
  }

  .loading-overlay.hidden { opacity: 0; pointer-events: none; }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(201,168,76,0.15);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(245,240,232,0.5);
  }

  /* LOCKED STATE */
  body.round-locked .strokes-input,
  body.round-locked .declaration-select,
  body.round-locked .hit-btn,
  body.round-locked .miss-btn,
  body.round-locked .moment-btn,
  body.round-locked .par-btn {
    pointer-events: none;
    opacity: 0.45;
  }

  body.round-locked .btn-end-round { display: none; }

  .locked-banner {
    display: none;
    background: rgba(201,168,76,0.08);
    border-bottom: 1px solid rgba(201,168,76,0.2);
    padding: 10px 24px;
    text-align: center;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--gold);
  }

  body.round-locked .locked-banner { display: block; }

  /* RESPONSIVE */
  @media (max-width: 640px) {
    nav { padding: 14px 20px; }
    .page { padding-left: 16px; padding-right: 16px; }
    .leaderboard { padding: 8px 16px; }
    .hole-header { padding: 14px 16px; }
    .player-scoring-row { padding: 16px; }
    .inputs-row { gap: 6px; }
    .strokes-input { width: 68px; font-size: 1.3rem; }
    .declaration-select { min-width: 0; flex: 1; }
    .btn-nav { padding: 10px 16px; }
  }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <p class="loading-text" id="loadingText">Loading round‚Ä¶</p>
</div>

<!-- NAV -->
<nav>
  <a href="index.html" class="nav-logo">4<span>FORE</span></a>
  <div class="nav-right">
    <div class="round-code-badge" id="roundCodeBadge" style="display:none">
      <span class="round-code-label">Code</span>
      <span class="round-code-value" id="roundCodeValue">‚Äî</span>
    </div>
    <span class="nav-round-label" id="navRoundLabel">Live Round</span>
    <button class="btn-end-round" id="endRoundBtn" onclick="endRound()">End Round</button>
  </div>
</nav>

<!-- LOCKED BANNER -->
<div class="locked-banner">Round Completed ‚Äî Scores are locked</div>

<!-- LEADERBOARD -->
<div class="leaderboard" id="leaderboard"></div>

<!-- PAGE -->
<div class="page" id="mainPage">
  <!-- VIEW TOGGLE -->
  <div class="view-toggle">
    <button class="toggle-btn active" id="toggleHole" onclick="setView('hole')">Current Hole</button>
    <button class="toggle-btn" id="toggleFull" onclick="setView('full')">Full Scorecard</button>
  </div>

  <!-- SINGLE HOLE VIEW -->
  <div id="holeViewWrap">
    <!-- HOLE PROGRESS PIPS -->
    <div class="hole-progress" id="holePips"></div>

    <!-- HOLE NAVIGATION -->
    <div class="hole-nav">
      <button class="btn-nav" id="prevBtn" disabled>‚Üê Prev</button>
      <span class="hole-nav-label" id="holeNavLabel">Hole 1 of 18</span>
      <button class="btn-nav" id="nextBtn">Next ‚Üí</button>
    </div>

    <!-- HOLE PANEL (rebuilt per hole) -->
    <div class="hole-panel" id="holeView"></div>
  </div>

  <!-- FULL SCORECARD VIEW -->
  <div class="full-scorecard-wrap" id="fullScorecardWrap"></div>
</div>

<script>
  // ‚îÄ‚îÄ Supabase state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const urlParams   = new URLSearchParams(window.location.search);
  let roundId       = urlParams.get('round');
  let roundLocked   = false;

  // Legacy URL param support
  const legacyCount = parseInt(urlParams.get('p')) || 0;

  // ‚îÄ‚îÄ App state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const players  = [];
  let currentHole = 0;
  let currentView = 'hole';
  let holeData   = [];

  function buildHoleData() {
    return Array.from({ length: 18 }, () => ({
      par: 4,
      players: players.map(() => ({
        strokes:     null,
        declaration: 'none',
        hit:         null,
        moments: { hio: false, sand: false, chip: false, pap: false }
      }))
    }));
  }

  // ‚îÄ‚îÄ Scoring logic (unchanged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function basePoints(strokes, par) {
    const diff = strokes - par;
    if (diff <= -3) return 10;
    if (diff === -2) return 6;
    if (diff === -1) return 4;
    if (diff === 0)  return 2;
    if (diff === 1)  return 1;
    return 0;
  }

  function holeScore(holeIdx, playerIdx) {
    const h  = holeData[holeIdx];
    const pd = h.players[playerIdx];
    const p  = players[playerIdx];
    if (pd.strokes === null) return null;
    let pts = basePoints(pd.strokes, h.par);
    if (pd.declaration !== 'none') {
      if (pd.hit === true)  pts = pts * p.mult;
      else if (pd.hit === false) pts = pts + 0.5;
    }
    if (pd.moments.hio)  pts += 44;
    if (pd.moments.sand) pts += 3;
    if (pd.moments.chip) pts += 2;
    if (pd.moments.pap)  pts += 2;
    return Math.round(pts * 10) / 10;
  }

  function totalScore(playerIdx) {
    let total = players[playerIdx].hs;
    for (let h = 0; h < 18; h++) {
      const s = holeScore(h, playerIdx);
      if (s !== null) total += s;
    }
    return Math.round(total * 10) / 10;
  }

  function holeHasAnyScore(holeIdx) {
    return holeData[holeIdx].players.some(pd => pd.strokes !== null);
  }

  // ‚îÄ‚îÄ Declarations available per par ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ALL_DECLARATIONS = [
    { value: 'none',     label: 'No Declaration' },
    { value: 'dtg',      label: 'Drive the Green' },
    { value: 'gfg2',     label: 'Go for Green in 2' },
    { value: 'shortcut', label: 'Short Cut' },
    { value: '1putt',    label: '1-Putt Par' },
    { value: 'cys',      label: 'Call Your Score' },
  ];

  function declarationsForPar(par) {
    return ALL_DECLARATIONS.filter(d => {
      if (d.value === 'dtg')  return par === 4;
      if (d.value === 'gfg2') return par === 5;
      return true;
    });
  }

  // ‚îÄ‚îÄ Render leaderboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderLeaderboard() {
    const lb = document.getElementById('leaderboard');
    if (players.length === 0) { lb.innerHTML = ''; return; }
    const scores = players.map((p, i) => ({ name: p.name, total: totalScore(i), idx: i }))
      .sort((a, b) => b.total - a.total);
    let rank = 1;
    scores.forEach((s, i) => {
      if (i > 0 && s.total < scores[i - 1].total) rank = i + 1;
      s.rank = rank;
    });
    const rankLabels = ['1ST', '2ND', '3RD', '4TH', '5TH', '6TH'];
    lb.innerHTML = scores.map(s => `
      <div class="lb-card rank-${Math.min(s.rank, 4)}">
        <div class="lb-rank">${rankLabels[s.rank - 1] || s.rank + 'TH'}</div>
        <div class="lb-name">${escHtml(s.name)}</div>
        <div class="lb-score">${s.total}</div>
      </div>
    `).join('');
  }

  // ‚îÄ‚îÄ Render hole progress pips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderPips() {
    const container = document.getElementById('holePips');
    container.innerHTML = Array.from({ length: 18 }, (_, i) => {
      let cls = 'hole-pip';
      if (i === currentHole) cls += ' current';
      else if (holeHasAnyScore(i)) cls += ' scored';
      return `<div class="${cls}" onclick="goHole(${i})" title="Hole ${i + 1}"></div>`;
    }).join('');
  }

  // ‚îÄ‚îÄ Render hole view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderHole(holeIdx) {
    const h = holeData[holeIdx];
    const decls = declarationsForPar(h.par);
    const holeView = document.getElementById('holeView');
    const parBtns = [3, 4, 5].map(p =>
      `<button class="par-btn${h.par === p ? ' active' : ''}" data-par="${p}">${p}</button>`
    ).join('');
    const playerRows = players.map((player, pi) => {
      const pd = h.players[pi];
      const declOptions = decls.map(d =>
        `<option value="${d.value}"${pd.declaration === d.value ? ' selected' : ''}>${d.label}</option>`
      ).join('');
      const declNotNone = pd.declaration !== 'none';
      const hitMissHidden = declNotNone ? '' : 'style="display:none"';
      const hitActive  = pd.hit === true  ? ' active' : '';
      const missActive = pd.hit === false ? ' active' : '';
      const momentBtns = [
        { key: 'hio',  label: '‚õ≥ Hole in One +44' },
        { key: 'sand', label: 'üèñ Sand Save +3' },
        { key: 'chip', label: '‚õ≥ Chip-In +2' },
        { key: 'pap',  label: '‚ö† Par After Penalty +2' },
      ].map(m =>
        `<button class="moment-btn${pd.moments[m.key] ? ' active' : ''}" data-player="${pi}" data-moment="${m.key}">${m.label}</button>`
      ).join('');
      const score = holeScore(holeIdx, pi);
      const scoreDisplay = score !== null ? score + ' pts' : '‚Äî';
      const scoreClass = score !== null ? ' has-score' : '';
      const multLabel = player.mult === 1 ? 'Scratch' : player.mult + '√ó';
      return `
        <div class="player-scoring-row">
          <div class="player-row-header">
            <div>
              <span class="player-label">${escHtml(player.name)}</span>
              <span class="player-mult-label">${multLabel}</span>
            </div>
            <span class="player-hole-score${scoreClass}" id="hole-score-${holeIdx}-${pi}">${scoreDisplay}</span>
          </div>
          <div class="inputs-row">
            <div class="input-group">
              <span class="input-label">Strokes</span>
              <input class="strokes-input" type="number" min="1" max="15" placeholder="‚Äî"
                value="${pd.strokes !== null ? pd.strokes : ''}" data-player="${pi}" data-hole="${holeIdx}"/>
            </div>
            <div class="input-group">
              <span class="input-label">Declaration</span>
              <select class="declaration-select" data-player="${pi}" data-hole="${holeIdx}">${declOptions}</select>
            </div>
            <div class="input-group hit-miss-wrap" data-hm-player="${pi}" ${hitMissHidden}>
              <span class="input-label">Hit?</span>
              <div style="display:flex;gap:2px;">
                <button class="hit-btn${hitActive}"  data-player="${pi}" data-hm="hit">HIT</button>
                <button class="miss-btn${missActive}" data-player="${pi}" data-hm="miss">MISS</button>
              </div>
            </div>
          </div>
          <div class="moments-row">${momentBtns}</div>
        </div>
      `;
    }).join('');
    holeView.innerHTML = `
      <div class="hole-header">
        <span class="hole-number">HOLE ${holeIdx + 1}</span>
        <div>
          <div class="par-label">Par</div>
          <div class="par-selector">${parBtns}</div>
        </div>
      </div>
      ${playerRows}
    `;
    document.getElementById('holeNavLabel').textContent = `Hole ${holeIdx + 1} of 18`;
    document.getElementById('prevBtn').disabled = holeIdx === 0;
    document.getElementById('nextBtn').disabled = holeIdx === 17;
    renderPips();
  }

  // ‚îÄ‚îÄ View toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setView(view) {
    currentView = view;
    document.getElementById('toggleHole').classList.toggle('active', view === 'hole');
    document.getElementById('toggleFull').classList.toggle('active', view === 'full');
    document.getElementById('holeViewWrap').style.display = view === 'hole' ? '' : 'none';
    const wrap = document.getElementById('fullScorecardWrap');
    if (view === 'full') {
      wrap.classList.add('visible');
      renderFullScorecard();
    } else {
      wrap.classList.remove('visible');
    }
  }

  // ‚îÄ‚îÄ Full scorecard render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const DECL_LABELS = {
    none: '', dtg: 'Drive Green', gfg2: 'Grn in 2',
    shortcut: 'Short Cut', '1putt': '1-Putt', cys: 'Call Score'
  };
  const MOMENT_LABELS = { hio: 'HiO+44', sand: 'Sand+3', chip: 'Chip+2', pap: 'PAP+2' };

  function renderFullScorecard() {
    const wrap = document.getElementById('fullScorecardWrap');
    const playerHeaders = players.map(p =>
      `<th class="player-col">${escHtml(p.name)}<br><span style="font-family:'Barlow Condensed';font-weight:600;font-size:0.6rem;color:rgba(245,240,232,0.4);letter-spacing:0.05em;">${p.mult}√ó</span></th>`
    ).join('');
    const rows = Array.from({ length: 18 }, (_, hi) => {
      const h = holeData[hi];
      const played = holeHasAnyScore(hi);
      const isCurrent = hi === currentHole;
      let cls = isCurrent ? 'hole-current' : (!played ? 'hole-unplayed' : '');
      const playerCells = players.map((_, pi) => {
        const pd = h.players[pi];
        const score = holeScore(hi, pi);
        if (!played || pd.strokes === null) return `<td class="player-col">‚Äî</td>`;
        const diff = pd.strokes - h.par;
        const diffLabel = diff <= -3 ? 'Albatross' : diff === -2 ? 'Eagle' : diff === -1 ? 'Birdie'
          : diff === 0 ? 'Par' : diff === 1 ? 'Bogey' : 'Dbl+';
        let declLine = '';
        if (pd.declaration !== 'none') {
          const hitSpan = pd.hit === true ? `<span class="sc-hit">HIT</span>`
            : pd.hit === false ? `<span class="sc-miss">MISS</span>` : '<span style="opacity:.4">‚Äî</span>';
          declLine = `<div class="sc-score-detail">${DECL_LABELS[pd.declaration] || pd.declaration} ¬∑ ${hitSpan}</div>`;
        }
        const momentKeys = Object.keys(pd.moments).filter(k => pd.moments[k]);
        const momentLine = momentKeys.length
          ? `<div class="sc-moments">${momentKeys.map(k => MOMENT_LABELS[k]).join(' ')}</div>` : '';
        return `
          <td class="player-col">
            <div class="sc-pts">${score !== null ? score : '‚Äî'}</div>
            <div class="sc-score-detail">${pd.strokes} strokes ¬∑ ${diffLabel}</div>
            ${declLine}${momentLine}
          </td>`;
      }).join('');
      return `
        <tr class="${cls}" onclick="jumpToHole(${hi})">
          <td><span class="sc-hole-num">${hi + 1}</span></td>
          <td><span class="sc-par">Par ${h.par}</span></td>
          ${playerCells}
        </tr>`;
    }).join('');
    const footerCells = players.map((p, pi) => {
      let basePts = 0, multPts = 0, momentPts = 0;
      for (let hi = 0; hi < 18; hi++) {
        const h = holeData[hi];
        const pd = h.players[pi];
        if (pd.strokes === null) continue;
        const base = basePoints(pd.strokes, h.par);
        const mPts = (pd.moments.hio ? 44 : 0) + (pd.moments.sand ? 3 : 0)
                   + (pd.moments.chip ? 2 : 0) + (pd.moments.pap ? 2 : 0);
        if (pd.declaration !== 'none' && pd.hit === true) {
          basePts += base;
          multPts += Math.round((base * p.mult - base) * 10) / 10;
        } else if (pd.declaration !== 'none' && pd.hit === false) {
          basePts += base + 0.5;
        } else {
          basePts += base;
        }
        momentPts += mPts;
      }
      basePts = Math.round(basePts * 10) / 10;
      multPts = Math.round(multPts * 10) / 10;
      momentPts = Math.round(momentPts * 10) / 10;
      return `
        <td class="player-col">
          <span class="tfoot-total">${totalScore(pi)}</span>
          <div class="tfoot-breakdown">
            Head start: +${p.hs}<br>
            Base: ${basePts} ¬∑ Mult bonus: +${multPts}<br>
            Moments: +${momentPts}
          </div>
        </td>`;
    }).join('');
    wrap.innerHTML = `
      <table class="full-scorecard-table">
        <thead><tr><th>Hole</th><th>Par</th>${playerHeaders}</tr></thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr>
            <td colspan="2" style="font-family:'Barlow Condensed';font-size:0.75rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);">Total</td>
            ${footerCells}
          </tr>
        </tfoot>
      </table>
    `;
  }

  function jumpToHole(idx) { setView('hole'); goHole(idx); }

  function goHole(idx) {
    if (idx < 0 || idx > 17) return;
    currentHole = idx;
    renderHole(currentHole);
    renderLeaderboard();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function updateHoleScoreDisplay(holeIdx, playerIdx) {
    const el = document.getElementById(`hole-score-${holeIdx}-${playerIdx}`);
    if (!el) return;
    const score = holeScore(holeIdx, playerIdx);
    if (score !== null) { el.textContent = score + ' pts'; el.classList.add('has-score'); }
    else { el.textContent = '‚Äî'; el.classList.remove('has-score'); }
  }

  function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let toastTimer = null;
  function showToast(msg, isError = false) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.toggle('error', isError);
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 3200);
  }

  // ‚îÄ‚îÄ Save to Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function saveHoleScore(holeIdx, playerIdx) {
    if (!roundId || roundLocked) return;
    const h  = holeData[holeIdx];
    const pd = h.players[playerIdx];
    const row = {
      round_id:     roundId,
      player_index: playerIdx,
      hole_number:  holeIdx,
      par:          h.par,
      strokes:      pd.strokes,
      declaration:  pd.declaration,
      hit:          pd.hit,
      moments_hio:  pd.moments.hio,
      moments_sand: pd.moments.sand,
      moments_chip: pd.moments.chip,
      moments_pap:  pd.moments.pap,
    };
    const { error } = await window.sb
      .from('hole_scores')
      .upsert(row, { onConflict: 'round_id,player_index,hole_number' });
    if (error) {
      console.warn('saveHoleScore failed:', error.message);
      showToast('Score not saved ‚Äî check connection', true);
    }
  }

  // ‚îÄ‚îÄ Apply a realtime score update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function applyRemoteScore(record) {
    const hi = record.hole_number;
    const pi = record.player_index;
    if (!holeData.length || pi >= players.length) return;
    const h  = holeData[hi];
    const pd = h.players[pi];
    h.par           = record.par;
    pd.strokes      = record.strokes;
    pd.declaration  = record.declaration || 'none';
    pd.hit          = record.hit;
    pd.moments.hio  = record.moments_hio;
    pd.moments.sand = record.moments_sand;
    pd.moments.chip = record.moments_chip;
    pd.moments.pap  = record.moments_pap;
    if (hi === currentHole) renderHole(currentHole);
    renderLeaderboard();
    renderPips();
    if (currentView === 'full') renderFullScorecard();
  }

  // ‚îÄ‚îÄ Realtime subscription ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function subscribeRealtime() {
    if (!roundId) return;
    window.sb
      .channel('hole_scores:' + roundId)
      .on('postgres_changes', {
        event: '*', schema: 'public', table: 'hole_scores',
        filter: 'round_id=eq.' + roundId,
      }, payload => {
        if (payload.new && payload.new.round_id === roundId) {
          applyRemoteScore(payload.new);
        }
      })
      .subscribe();
  }

  // ‚îÄ‚îÄ End round ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function endRound() {
    if (!roundId) { window.location.href = 'round.html'; return; }
    if (!confirm('End this round and lock all scores?')) return;
    const { error } = await window.sb
      .from('rounds')
      .update({ status: 'completed' })
      .eq('id', roundId);
    if (error) { showToast('Could not end round ‚Äî try again', true); return; }
    window.location.href = 'round.html';
  }

  // ‚îÄ‚îÄ Event delegation on holeView ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('holeView').addEventListener('input', e => {
    if (!e.target.classList.contains('strokes-input')) return;
    const pi  = parseInt(e.target.dataset.player);
    const val = parseInt(e.target.value);
    holeData[currentHole].players[pi].strokes = isNaN(val) || val < 1 ? null : val;
    updateHoleScoreDisplay(currentHole, pi);
    renderLeaderboard();
    renderPips();
    if (currentView === 'full') renderFullScorecard();
    saveHoleScore(currentHole, pi);
  });

  document.getElementById('holeView').addEventListener('change', e => {
    if (!e.target.classList.contains('declaration-select')) return;
    const pi  = parseInt(e.target.dataset.player);
    const val = e.target.value;
    holeData[currentHole].players[pi].declaration = val;
    if (val === 'none') holeData[currentHole].players[pi].hit = null;
    const hmWrap = document.querySelector(`.hit-miss-wrap[data-hm-player="${pi}"]`);
    if (hmWrap) hmWrap.style.display = val === 'none' ? 'none' : '';
    updateHoleScoreDisplay(currentHole, pi);
    renderLeaderboard();
    if (currentView === 'full') renderFullScorecard();
    saveHoleScore(currentHole, pi);
  });

  document.getElementById('holeView').addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;

    if (btn.classList.contains('par-btn')) {
      const newPar = parseInt(btn.dataset.par);
      holeData[currentHole].par = newPar;
      const validDecls = declarationsForPar(newPar).map(d => d.value);
      holeData[currentHole].players.forEach((pd, pi) => {
        if (!validDecls.includes(pd.declaration)) { pd.declaration = 'none'; pd.hit = null; }
        saveHoleScore(currentHole, pi);
      });
      renderHole(currentHole);
      renderLeaderboard();
      if (currentView === 'full') renderFullScorecard();
      return;
    }

    if (btn.dataset.hm) {
      const pi    = parseInt(btn.dataset.player);
      const isHit = btn.dataset.hm === 'hit';
      const current = holeData[currentHole].players[pi].hit;
      if ((isHit && current === true) || (!isHit && current === false)) {
        holeData[currentHole].players[pi].hit = null;
        btn.classList.remove('active');
      } else {
        holeData[currentHole].players[pi].hit = isHit;
        const hmWrap = document.querySelector(`.hit-miss-wrap[data-hm-player="${pi}"]`);
        if (hmWrap) {
          hmWrap.querySelector('.hit-btn').classList.toggle('active', isHit);
          hmWrap.querySelector('.miss-btn').classList.toggle('active', !isHit);
        }
      }
      updateHoleScoreDisplay(currentHole, pi);
      renderLeaderboard();
      if (currentView === 'full') renderFullScorecard();
      saveHoleScore(currentHole, pi);
      return;
    }

    if (btn.classList.contains('moment-btn')) {
      const pi = parseInt(btn.dataset.player);
      const m  = btn.dataset.moment;
      holeData[currentHole].players[pi].moments[m] = !holeData[currentHole].players[pi].moments[m];
      btn.classList.toggle('active');
      updateHoleScoreDisplay(currentHole, pi);
      renderLeaderboard();
      if (currentView === 'full') renderFullScorecard();
      saveHoleScore(currentHole, pi);
      return;
    }
  });

  document.getElementById('prevBtn').addEventListener('click', () => goHole(currentHole - 1));
  document.getElementById('nextBtn').addEventListener('click', () => goHole(currentHole + 1));

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function initRound() {
    const overlay = document.getElementById('loadingOverlay');
    const loadTxt = document.getElementById('loadingText');

    // Legacy URL params (no round= param)
    if (!roundId && legacyCount > 0) {
      for (let i = 0; i < legacyCount; i++) {
        players.push({
          name: urlParams.get('n' + i) || 'Player ' + (i + 1),
          mult: parseFloat(urlParams.get('m' + i)) || 1.5,
          hs:   parseInt(urlParams.get('hs' + i))  || 0,
        });
      }
      holeData = buildHoleData();
      overlay.classList.add('hidden');
      document.getElementById('navRoundLabel').textContent = players.map(p => p.name.split(' ')[0]).join(' ¬∑ ');
      renderHole(0);
      renderLeaderboard();
      return;
    }

    // No round ID at all
    if (!roundId) {
      overlay.classList.add('hidden');
      document.getElementById('mainPage').innerHTML = `
        <div class="no-players">
          <h2>No Round Found</h2>
          <p>Start a new round or join one with a code.</p>
          <a href="round.html" class="btn-primary">Set Up Round</a>
        </div>
      `;
      document.getElementById('leaderboard').innerHTML = '';
      return;
    }

    // Fetch from Supabase
    try {
      loadTxt.textContent = 'Loading round‚Ä¶';

      const { data: round, error: roundErr } = await window.sb
        .from('rounds')
        .select('id, status, code')
        .eq('id', roundId)
        .single();

      if (roundErr || !round) throw new Error('Round not found');

      document.getElementById('roundCodeBadge').style.display = 'flex';
      document.getElementById('roundCodeValue').textContent = round.code;

      if (round.status === 'completed') {
        roundLocked = true;
        document.body.classList.add('round-locked');
      }

      loadTxt.textContent = 'Loading players‚Ä¶';
      const { data: roundPlayers, error: playersErr } = await window.sb
        .from('round_players')
        .select('player_index, name, multiplier, head_start')
        .eq('round_id', roundId)
        .order('player_index');

      if (playersErr || !roundPlayers || !roundPlayers.length) throw new Error('Players not found');

      roundPlayers.forEach(rp => {
        players.push({ name: rp.name, mult: rp.multiplier, hs: rp.head_start });
      });

      holeData = buildHoleData();

      loadTxt.textContent = 'Loading scores‚Ä¶';
      const { data: scores } = await window.sb
        .from('hole_scores')
        .select('*')
        .eq('round_id', roundId);

      if (scores) {
        scores.forEach(row => {
          const h  = holeData[row.hole_number];
          const pd = h.players[row.player_index];
          h.par           = row.par;
          pd.strokes      = row.strokes;
          pd.declaration  = row.declaration || 'none';
          pd.hit          = row.hit;
          pd.moments.hio  = row.moments_hio;
          pd.moments.sand = row.moments_sand;
          pd.moments.chip = row.moments_chip;
          pd.moments.pap  = row.moments_pap;
        });
      }

      overlay.classList.add('hidden');
      document.getElementById('navRoundLabel').textContent = players.map(p => p.name.split(' ')[0]).join(' ¬∑ ');
      renderHole(0);
      renderLeaderboard();
      subscribeRealtime();

    } catch (err) {
      console.error('initRound error:', err);
      overlay.classList.add('hidden');
      document.getElementById('mainPage').innerHTML = `
        <div class="no-players">
          <h2>Could Not Load Round</h2>
          <p>${escHtml(err.message || 'Unknown error')}</p>
          <a href="round.html" class="btn-primary">Back to Setup</a>
        </div>
      `;
      document.getElementById('leaderboard').innerHTML = '';
    }
  }

  initRound();
</script>

<div class="toast" id="toast"></div>

</body>
</html>
